<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inspection ATEX Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1/dist/html2canvas.min.js"></script>
  <style>
    body{font-family:system-ui;margin:0;padding:1rem;background:#f1f5f9}
    .c{max-width:900px;margin:auto;background:white;padding:2rem;border-radius:1rem;box-shadow:0 4px 20px rgba(0,0,0,.1)}
    h1{text-align:center;color:#dc2626;margin-bottom:.5rem}
    .info{text-align:center;color:#64748b;margin-bottom:1.5rem;font-size:.9rem}
    input,textarea,select,button{width:100%;padding:.75rem;margin:.5rem 0;border:1px solid #ddd;border-radius:.5rem;font-size:1rem}
    button{background:#dc2626;color:white;font-weight:bold;cursor:pointer;border:none}
    button:hover{opacity:.9}
    .i{display:grid;grid-template-columns:40px 60px 120px 120px 1fr 80px 40px;gap:.5rem;padding:1rem;background:#fef2f2;border:1px solid #fecaca;border-radius:.75rem;margin-bottom:.5rem;align-items:center}
    .d{cursor:grab;font-size:1.5rem;text-align:center}
    .r{background:#ef4444;color:white;padding:.25rem .5rem;font-size:.8rem;border-radius:.5rem}
    .zone{font-weight:bold;text-align:center}
    .a{display:flex;gap:.5rem;margin-top:1.5rem;flex-wrap:wrap}
    .b{flex:1;background:#059669}
    .pdf{background:#8b5cf6}
    @media (max-width:768px){.i{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      const [title, setTitle] = useState("Inspection ATEX - Site Chimique");
      const [items, setItems] = useState([
        {id:1, equip:"Moteur Ex", zone:"1", cert:"Ex d", desc:"Vérifier étanchéité", checked:true, notes:"OK"},
        {id:2, equip:"Capteur", zone:"0", cert:"Ex i", desc:"Câblage", checked:false, notes:"À refaire"},
        {id:3, equip:"Luminaire", zone:"2", cert:"Ex e", desc:"Test", checked:true, notes:"Fonctionnel"}
      ]);

      useEffect(() => {
        const saved = localStorage.getItem('atex-data');
        if (saved) {
          const data = JSON.parse(saved);
          setTitle(data.title || "");
          setItems(data.items || []);
        }
      }, []);

      useEffect(() => {
        const t = setTimeout(() => {
          localStorage.setItem('atex-data', JSON.stringify({title, items}));
        }, 500);
        return () => clearTimeout(t);
      }, [title, items]);

      const add = () => setItems([...items, {id:Date.now(), equip:"", zone:"", cert:"", desc:"", checked:false, notes:""}]);
      const del = (id) => setItems(items.filter(i=>i.id!==id));
      const upd = (id,f,v) => setItems(items.map(i=>i.id===id?{...i,[f]:v}:i));

      const pdf = () => {
        html2canvas(document.querySelector(".c"), {scale:2}).then(c => {
          const i = c.toDataURL("image/png");
          const p = new jsPDF('p','mm','a4');
          const w = p.internal.pageSize.getWidth();
          const h = (c.height * w) / c.width;
          p.addImage(i,'PNG',0,0,w,h);
          p.save(`ATEX_${title.replace(/[^a-z0-9]/gi,'_')}.pdf`);
        });
      };

      return (
        <div className="c">
          <h1>Inspection ATEX Pro</h1>
          <p className="info">Directive 2014/34/UE • Sauvegarde auto • PDF pro</p>
          <input value={title} onChange={e=>setTitle(e.target.value)} placeholder="Titre de l'inspection" />
          
          <div style={{fontWeight:'bold', display:'grid', gridTemplateColumns:'40px 60px 120px 120px 1fr 80px 40px', gap:'.5rem', margin:'1rem 0 .5rem', fontSize:'.8rem', color:'#dc2626'}}>
            <div></div><div></div><div>Équip.</div><div>Zone</div><div>Description</div><div>Certif.</div><div></div>
          </div>

          {items.map(i=>(
            <div key={i.id} className="i">
              <div className="d">☰</div>
              <input type="checkbox" checked={i.checked} onChange={e=>upd(i.id,'checked',e.target.checked)} />
              <input value={i.equip} onChange={e=>upd(i.id,'equip',e.target.value)} placeholder="Équipement" />
              <select value={i.zone} onChange={e=>upd(i.id,'zone',e.target.value)} className="zone">
                <option value="">Zone</option>
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="20">20</option>
                <option value="21">21</option>
                <option value="22">22</option>
              </select>
              <input value={i.desc} onChange={e=>upd(i.id,'desc',e.target.value)} placeholder="À vérifier" />
              <input value={i.cert} onChange={e=>upd(i.id,'cert',e.target.value)} placeholder="Ex d, Ex i..." />
              <textarea value={i.notes} onChange={e=>upd(i.id,'notes',e.target.value)} placeholder="Notes" rows="1" />
              <button className="r" onClick={()=>del(i.id)} disabled={items.length===1}>X</button>
            </div>
          ))}

          <button onClick={add} style={{background:'#6366f1'}}>+ Ajouter un équipement</button>

          <div className="a">
            <button className="b" onClick={()=>alert("Sauvegardé localement !")}>Sauvegarder</button>
            <button className="pdf" onClick={pdf}>PDF</button>
          </div>
        </div>
      );
    }

    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.
